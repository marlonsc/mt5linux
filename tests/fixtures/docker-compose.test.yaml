# docker-compose.test.yaml - ISOLATED container for UNIT tests of mt5linux
#
# DOES NOT affect production mt5 container (port 8001)
# DOES NOT conflict with neptor tests (port 28812) or mt5docker
# Uses completely separate ports and volumes
#
# Location: tests/fixtures/docker-compose.test.yaml
# Paths are relative to this file
#
# Usage:
#   cd mt5linux
#   docker compose -f tests/fixtures/docker-compose.test.yaml up -d
#   pytest tests/ -v
#
# Or pytest auto-starts via conftest.py

services:
  mt5-unit:
    build:
      context: ../../../mt5docker
      dockerfile: Dockerfile
    image: mt5docker:unit
    container_name: mt5linux-unit
    ports:
      - "33000:3000"    # VNC isolated (no conflict with 3000/23000)
      - "38812:8001"    # RPyC isolated (no conflict with 8001/28812!)
      - "38002:8002"    # Health isolated (no conflict with 8002/28002)
    volumes:
      # ISOLATED volumes (not shared with production or neptor)
      - mt5linux_unit_config:/config:uid=911,gid=911
      - mt5linux_unit_downloads:/downloads:uid=911,gid=911
      - mt5linux_unit_cache:/cache:uid=911,gid=911
      # Mount LOCAL mt5linux code as Python package
      # ../../mt5linux -> /opt/mt5linux-pkg/mt5linux (for import mt5linux to work)
      - ../../mt5linux:/opt/mt5linux-pkg/mt5linux:ro
    env_file:
      - ../../.env
    environment:
      # Use local code via PYTHONPATH (parent directory of package)
      - PYTHONPATH=/opt/mt5linux-pkg
      # MT5 credentials from .env (mapped to container env vars)
      - MT5_LOGIN=${MT5_TEST_LOGIN}
      - MT5_PASSWORD=${MT5_TEST_PASSWORD}
      - MT5_SERVER=${MT5_TEST_SERVER:-MetaQuotes-Demo}
      # Container settings
      - ENABLE_WIN_DOTNET=1
      - ENABLE_DATA_SYNC=0
      - TZ=UTC
      # RPyC settings
      - RPYC_RESILIENT=1
      - RPYC_HEALTH_PORT=8002
      - RPYC_MAX_RESTARTS=5
      - RPYC_MAX_CONNECTIONS=5
    restart: "no"
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined
    healthcheck:
      test: ["CMD", "bash", "-c", "echo >/dev/tcp/localhost/8001"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

volumes:
  mt5linux_unit_config:
    name: mt5linux_unit_config
    labels:
      description: "MT5 unit test configuration (isolated)"
  mt5linux_unit_downloads:
    name: mt5linux_unit_downloads
    labels:
      description: "MT5 unit test downloads (isolated)"
  mt5linux_unit_cache:
    name: mt5linux_unit_cache
    labels:
      description: "MT5 unit test cache (isolated)"
